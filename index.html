<html>
<head>
    <meta name="viewport" content="width=device-width" />
    
	<script type="text/javascript" 
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" /> 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>

    <script src="getFunds.js"></script>


	<script type="text/javascript">
        var FundDetails = [];
        var FundSelected = [];
        var FundData = [];
        var id = 1;

        $(document).ready(function () {		
            
        $("#FundInput").select2();

			$.ajax({ 
           method: "get", 
           url: "https://script.google.com/macros/s/AKfycbzEqBzXTk0EPb9Hln-sw72hkUnDZD0C4_c_9laHcpL9KglW5R3ZLUpgrtgZpwcoxncYXg/exec"
        //    data: {}

         }).done(function( data ) { 

           var result = data; 
		   	console.log(result.data[1].FundName);
			$('p').append("Loaded");
			// console.log("Printing result");

			for (fund in result.data){
				// console.log(result.data[fund].FundName);
				FundDetails.push([result.data[fund].FundName, result.data[fund].Link]);

			}
			// console.log(FundDetails);

			// return FundDetails;

		});
    });

        function addRow(){
            var DivString = ' <div class = "container"> <div class = "row"> <div class="form-outline mb-4"> \
            <select id="FundInput' + id +'"';  
            
            for (fund in FundDetails){
                DivString = DivString + "<option>";
                // console.log(FundDetails[fund][0]);
                DivString = DivString + FundDetails[fund][0];
                DivString = DivString + "</option>";
            }
            DivString = DivString + "</select></div> ";

            DivString = DivString + '<div><input type="number" class="form-outline mb-4"  placeholder="Enter Amount" id="Amount' + id +'"> </div>';
            // check mark for making making it the comparison? 
            DivString = DivString + ' <div class="form-check form-switch"> \
                <input class="form-check-input" type="checkbox" id="Fundselect' + id +'"> </div>';

            DivString = DivString + "</div></div>";
            $('#Funds').append(DivString); 
            $('#FundInput'+id).select2();
    
            id = id + 1;

            }

        // search for the links of the funds selected
        function getLink(fundName){
            for (var i=1; i< FundDetails.length; i++){
                if (FundDetails[i][0] == fundName){
                    return FundDetails[i][1];
                }
            }

        }    

        //// get data from the link

        function getdata(Funds){
            var fundname_concat = [];
            FundData = [];

            for (fund in Funds){
                fundname_concat = fundname_concat + Funds[fund][0] + ", ";
            }
            console.log(fundname_concat);

            console.log("Getting data from appsciprt");
            $.ajax({ 
                method: "get", 
                url: "https://script.google.com/macros/s/AKfycbyIy6shJ7Mh1Zxlo3ERwMatVcXIEmNvvbn7smzQ6l0ki4cSQg62hfJicZUaduV-MgFF/exec",
                data: {
                fundName : fundname_concat
            }

            }).done(function( data ) {     
                var result = data["data"]; 
                generatePorfolio(Funds,result);
                 })
                
      
        }

        function generatePorfolio(Funds, FundDetails){

            // get share of fund for each stock.

            var securityWise = {};
            var industryWise = {};

            var UserFunds = Funds[0].map((_, colIndex) => Funds.map(row => row[colIndex])); // transpose

            var portfolioAmount  =  UserFunds[1].reduce((a, b) => a + b, 0);

            // get the single fund name which is to be compared with the portfolio
            var compFund = UserFunds[0][ UserFunds[2].indexOf(true)]; 
            
            document.getElementById("message1").innerHTML = "Comparing the selected fund, " + compFund + ", with rest of the Portfolio";

            for (row in FundDetails){
                // multiply the security fractional ammount with the fund amount
                var Amount = UserFunds[1][ UserFunds[0].indexOf(FundDetails[row][0])];
                var secAmount = (FundDetails[row][3]*Amount);
                FundDetails[row].push(secAmount );

                //sumarise by security wise
                if ( FundDetails[row][1] in securityWise ){     // { "security name 1" : [ amount , portfolio_percentage, compfund_shareholding], "security name w" : [ amount , portfolio_percentage, compfund_shareholding],...  }
                    // security already exists, add the amounts
                    securityWise[FundDetails[row][1]][0] += secAmount; // amount
                    securityWise[FundDetails[row][1]][1] += (secAmount/portfolioAmount); // as percentage
                    securityWise[FundDetails[row][1]][2] = checkCompFund(compFund,FundDetails[row]);

                } else{
                    //security doesnt exists, add the security and the amount
                    securityWise[FundDetails[row][1]] = [ secAmount , secAmount/portfolioAmount, checkCompFund(compFund,FundDetails[row]) ] ;
                }

                //sumarise by industry wise
                if ( FundDetails[row][2] in industryWise ){
                    // security already exists, add the amounts
                    industryWise[FundDetails[row][2]][0] += secAmount;
                    industryWise[FundDetails[row][2]][1] += secAmount/portfolioAmount;
                } else{
                    //security doesnt exists, add the security and the amount
                    industryWise[FundDetails[row][2]] = [ secAmount, secAmount/portfolioAmount];
                }

            }
            // console.log(FundDetails);
            console.log(securityWise);
            
            // check the value of overlap
            document.getElementById("message2").innerHTML= "The overlap is " + dotProduct(securityWise) + " %" ;

            // plot overview graphs
        
            var limit = 30;
            var data_sec = getSortedData(securityWise);  //  data_sec = [   [secuty 1, secury 2, ... ], [amt1, amt2,...],  [per1, per2,... ] ]
            var myChart_sec = new Chart("myChart_sec", {
                    type: "bar",
                    data: {labels: data_sec[0].slice(0, limit),
                        datasets: [{ data:data_sec[1].slice(0, limit)}]
                    },
                    options: {}
                    });

            var data_ind = getSortedData(industryWise);
            var myChart_ind = new Chart("myChart_ind", {
                    type: "bar",
                    data: {labels: data_ind[0].slice(0, limit),
                        datasets: [{ data:data_ind[1].slice(0, limit) }]
                    },
                    options: {}
                    });

    


        }

        function dotProduct(vectors){
            
            var dot_sum = 0;
            var a_sum = 0;
            var b_sum = 0;

            for (row in vectors){
                // console.log(vectors[row]);
                var a = Number(vectors[row][1] );
                var b = Number(vectors[row][2] );
                dot_sum += (a*b);
                a_sum += (a*a);
                b_sum += (b*b);
            }
            // console.log(dot_sum);
            // console.log(a_sum);
            // console.log(Math.sqrt(dot_sum));
            // console.log(Math.sqrt(a_sum));

            var value = (100*dot_sum/(Math.sqrt(a_sum)*Math.sqrt(b_sum))) ;
            console.log(value);
            return  Math.round(value );


        }

        function checkCompFund(fundName,fundDetailRow){
         
            if(fundName == fundDetailRow[0]){
                return (fundDetailRow[3]);
            }else{
                return 0;
            }
        }
        

        function getSortedData(dict){
   
            var items = Object.keys(dict).map(function(key) {
                  return [key, dict[key][0],dict[key][1]];
                });

            items.sort(function(first, second) {
                return second[1] - first[1];
            });

            items  = transpose(items);
            
            return items;

        }

        function transpose(arr){
            var arr_t = arr[0].map((_, colIndex) => arr.map(row => row[colIndex])); // transpose
            return arr_t
        }

        function calculate(){
            document.getElementById("message2").innerHTML= "Calculating...." ;
            var FundSelected = [];
            // var FundData = [];
        
            // get the funds selected and its link in the form of an array
            for (var i=1 ; i < id ; i++){
                var fund = document.getElementById("FundInput"+i).options[document.getElementById("FundInput"+i).selectedIndex].text;
                var fundAmount = document.getElementById("Amount"+i).value;
                var selected = document.getElementById("Fundselect"+i).checked;                
                // console.log(fund);
                FundSelected.push([fund,Number(fundAmount),selected]); 

            }

            getdata(FundSelected);


        }


      
        </script>


</head>
<body>
	
    <h1> Analyser
    </h1>
<p>

</p>
    <section class="w-100 p-4 d-flex justify-content-center pb-4">
   
    <div>

    
    <form style="width: 50rem;">
        <div>
        </div>

    <div id='Funds'>
    </div>
    
    <div class="row">
    <button type="button" id="AddFundsBtn" onclick="addRow()" class="btn btn-primary btn-block mb-4">Add Fund</button>
    </div>
    
    <br>

    <button type="button" id="Calculate" onclick="calculate()" class="btn btn-primary btn-block mb-4">Calulate</button>
    </form>
    </div>


</section>

<p id="message1">

</p>
<br>
<h2 id="message2">

</h2>


<canvas id="myChart_sec" style="width:100%;max-width:700px"></canvas>
<canvas id="myChart_ind" style="width:100%;max-width:700px"></canvas>


    
</body>
</html>
