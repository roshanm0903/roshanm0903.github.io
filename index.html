<html>
<head>
    <meta name="viewport" content="width=device-width" />
    
	<script type="text/javascript" 
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" /> 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <script src="getFunds.js"></script>


	<script type="text/javascript">
        var FundDetails = [];
        var FundSelected = [];
        var FundData = [];
        var id = 1;

        $(document).ready(function () {		
            
        $("#FundInput").select2();

			$.ajax({ 
           method: "get", 
           url: "https://script.google.com/macros/s/AKfycbzEqBzXTk0EPb9Hln-sw72hkUnDZD0C4_c_9laHcpL9KglW5R3ZLUpgrtgZpwcoxncYXg/exec"
        //    data: {}

         }).done(function( data ) { 

           var result = data; 
		   	console.log(result.data[1].FundName);
			$('p').append("Loaded");
			// console.log("Printing result");

			for (fund in result.data){
				// console.log(result.data[fund].FundName);
				FundDetails.push([result.data[fund].FundName, result.data[fund].Link]);

			}
			// console.log(FundDetails);

			// return FundDetails;

		});
    });

        function addRow(){
            var DivString = ' <div class = "container"> <div class = "row"> <div class="form-outline mb-4"> \
            <select id="FundInput' + id +'"';  
            
            for (fund in FundDetails){
                DivString = DivString + "<option>";
                // console.log(FundDetails[fund][0]);
                DivString = DivString + FundDetails[fund][0];
                DivString = DivString + "</option>";
            }
            DivString = DivString + "</select></div> ";

            DivString = DivString + '<div><input type="number" class="form-outline mb-4" id="Amount" placeholder="Enter Amount"' + id +'> </div>';
            // check mark for making making it the comparison? 
            DivString = DivString + "</div></div>";
            $('#Funds').append(DivString); 
            $('#FundInput'+id).select2();
    
            id = id + 1;

            }

        // search for the links of the funds selected
        function getLink(fundName){
            for (var i=1; i< FundDetails.length; i++){
                if (FundDetails[i][0] == fundName){
                    return FundDetails[i][1];
                }
            }

        }    

        //// get data from the link

        function getdata(Funds){
            var fundname_concat = [];

            for (fund in Funds){
                fundname_concat = fundname_concat + Funds[fund][0] + " ";
            }

            console.log("Getting data from appsciprt");
            $.ajax({ 
                method: "get", 
                url: "https://script.google.com/macros/s/AKfycbyIy6shJ7Mh1Zxlo3ERwMatVcXIEmNvvbn7smzQ6l0ki4cSQg62hfJicZUaduV-MgFF/exec",
                data: {
                fundName : fundname_concat
            }

            }).done(function( data ) {            
                var result = data; 
                console.log(result);
                FundData.push[result];

                            
                 })
            }
            
            // var urlString = "https://script.google.com/macros/s/AKfycbxjaHWev0cU8dFv1aVaaNDBGuNzcnTgno68z-w3KtphUWcPrEHKLnaI9C25lVYVLmBX/exec" + "?fundName=" + Funds[fund][0];
            
            // getapi(urlString);

            // }

            console.log(FundData);    
            // var urlString = " https://script.google.com/macros/s/AKfycbxjaHWev0cU8dFv1aVaaNDBGuNzcnTgno68z-w3KtphUWcPrEHKLnaI9C25lVYVLmBX/exec" + "?fundName=" +  encodeURI(Funds[fund][0]);
            // // urlParams = parseURLParams(urlString);
            // // console.log(urlParams);

            // // async function funcName(urlString){
            //     console.log("Getting data 2 " + urlString);
            //     const response =  fetch(urlString);
            //         // var data = response.json();
            //         console.log(response);
            // // }


            // let url = " https://script.google.com/macros/s/AKfycbxjaHWev0cU8dFv1aVaaNDBGuNzcnTgno68z-w3KtphUWcPrEHKLnaI9C25lVYVLmBX/exec" + "?fundName=" +  encodeURI(Funds[fund][0]);
            
            // let params = (new URL(url)).searchParams;
            // params.get('name') # => "n1"
            // params.getAll('name') # => ["n1", "n2"]

            // }
        // }
            


        function calculate(){
        
            // get the funds selected and its link in the form of array
            for (var i=1 ; i < id ; i++){
                var fund = document.getElementById("FundInput"+i).options[document.getElementById("FundInput"+i).selectedIndex].text;
                console.log(fund);
                FundSelected.push([fund , getLink(fund)]); 
                getdata(FundSelected);
                // console.log(FundSelected);
                // $('#Funds').append(FundSelected);
            }

            // perform dot product between the first and second fund

        }

        // function parseURLParams(url) {
        // var queryStart = url.indexOf("?") + 1,
        // queryEnd   = url.indexOf("#") + 1 || url.length + 1,
        // query = url.slice(queryStart, queryEnd - 1),
        // pairs = query.replace(/\+/g, " ").split("&"),
        // parms = {}, i, n, v, nv;

        //     if (query === url || query === "") return;

        //     for (i = 0; i < pairs.length; i++) {
        //         nv = pairs[i].split("=", 2);
        //         n = decodeURIComponent(nv[0]);
        //         v = decodeURIComponent(nv[1]);

        //         if (!parms.hasOwnProperty(n)) parms[n] = [];
        //         parms[n].push(nv.length === 2 ? v : null);
        //     }
        // return parms;

        // };



      
        </script>


</head>
<body>
	
    <h1> Analyser
    </h1>
<p>

</p>
    <section class="w-100 p-4 d-flex justify-content-center pb-4">
   
    <div>

    
    <form style="width: 50rem;">
        <div>

        </div>
        <!-- <div class="form-group"> -->

    <div id='Funds'>
    </div>
    
    <div class="row">
    <button type="button" id="AddFundsBtn" onclick="addRow()" class="btn btn-primary btn-block mb-4">Add Fund</button>
    </div>
    
    <br>

    <button type="button" id="Calculate" onclick="calculate()" class="btn btn-primary btn-block mb-4">Calulate</button>
    </form>
    </div>

    <div class="spinner-border" 
                 role="status" id="loading">
                <span class="sr-only">Loading...</span>
            </div>

</section>


    
</body>
</html>
