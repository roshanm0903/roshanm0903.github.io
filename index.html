<!DOCTYPE html>
<html lang=”en” manifest="/cache.appcache">
<head>
    <title>Portfolio Analyzer</title>
    <meta name="viewport" content="width=device-width" />
    
	<script type="text/javascript" 
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" /> 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>

    <script src="getFunds.js"></script>


	<script type="text/javascript">
        var FundDetails = [];
        var FundSelected = [];
        var FundData = [];
        var FundDatatDict = {};
        var id = 1;

        $(document).ready(function () {		
            document.getElementById("AddFundsBtn").style.display = "none";
            document.getElementById("AnalyzePortfolioBtn").style.display = "none";
            document.getElementById("FindSelectedOverlapBtn").style.display = "none";
            document.getElementById("FindAllOverlapsBtn").style.display = "none";
            document.getElementById("message1").innerHTML= "Loading...." ;
        $("#FundInput").select2();

			$.ajax({ 
           method: "get", 
           url: "https://script.google.com/macros/s/AKfycbzEqBzXTk0EPb9Hln-sw72hkUnDZD0C4_c_9laHcpL9KglW5R3ZLUpgrtgZpwcoxncYXg/exec"
        //    data: {}

         }).done(function( data ) { 

           var result = data; 
		   	console.log(result.data[1].FundName);
            document.getElementById("message1").innerHTML= "Loaded" ;
			// console.log("Printing result");
            document.getElementById("AddFundsBtn").style.display = "block";
            document.getElementById("AnalyzePortfolioBtn").style.display = "block";
            document.getElementById("FindSelectedOverlapBtn").style.display = "block";

			for (fund in result.data){
				// console.log(result.data[fund].FundName);
				FundDetails.push([result.data[fund].FundName, result.data[fund].Link]);

			}
			// console.log(FundDetails);

			// return FundDetails;

		});
    });
        
        function RemoveFundRow(fundRowId){
            document.getElementById(fundRowId).remove();
        }

        function addRow(){
            var DivString = ' <div class = "container" id="FundRow' + id +'"';  
            
            DivString = DivString + '"> <div class = "row"> <div class="form-outline mb-4">';
            DivString = DivString + '<select id="FundInput' + id +'">';  
            
            DivString = DivString + '<option value="" disabled selected>Select your fund</option>';

            for (fund in FundDetails){
                DivString = DivString + "<option>";
                // console.log(FundDetails[fund][0]);
                DivString = DivString + FundDetails[fund][0];
                DivString = DivString + "</option>";
            }
            DivString = DivString + "</select></div> ";
            // check mark for making making it the comparison? 
            DivString = DivString + ' <div class="form-check form-switch"> \
                <input class="form-check-input" type="checkbox" id="Fundselect' + id +'"> </div>';
            // remove fund
            DivString = DivString + '<button type="button" class="close" aria-label="Close" onclick= RemoveFundRow("FundRow' +id+ '")>';
            DivString = DivString +  '<span aria-hidden="true">&times;</span></button>';
                // amount input
            DivString = DivString + '<div><input type="number" class="form-outline mb-4"  placeholder="Enter Amount" id="Amount' + id +'"> </div>';
            

            DivString = DivString + "</div></div>";
            $('#Funds').append(DivString); 
            $('#FundInput'+id).select2();
    
            id = id + 1;

            //one one can be selected
            $('input.form-check-input').on('change', function() {
                     $('input.form-check-input').not(this).prop('checked', false);  
                    });
            
            //restrict to numbers
            // $('input.number').on('input', function() {
            //     this.value = this.value.replace(/[^0-9.]/g,'').replace(/(\..*)\./g, '$1');
            // });



        }
  

        function getFundData(Funds) {
            var fundname_concat = [];

            for (fund in Funds){
                fundname_concat = fundname_concat + Funds[fund][0] + ", ";
            }
            console.log(fundname_concat);

            console.log("Getting data from appsciprt");

            return new Promise(function(resolve, reject) {
                $.ajax({
                method: "get",
                url: "https://script.google.com/macros/s/AKfycbyIy6shJ7Mh1Zxlo3ERwMatVcXIEmNvvbn7smzQ6l0ki4cSQg62hfJicZUaduV-MgFF/exec",
                data: { fundName : fundname_concat },
                success: function(data) {
                    resolve(data["data"]); // Resolve promise and go to then()
                },
                error: function(err) {
                    reject(err); // Reject the promise and go to catch()
                }
                });
            });
        }

        function generatePorfolio(Funds, Data){

            var FundData = Data;

            // get share of fund for each stock.
            var securityWise = {};
            var industryWise = {};

            var UserFunds = Funds[0].map((_, colIndex) => Funds.map(row => row[colIndex])); // transpose

            var portfolioAmount  =  UserFunds[1].reduce((a, b) => a + b, 0);

            // get the single fund name which is to be compared with the portfolio
            var compFund = UserFunds[0][ UserFunds[2].indexOf(true)]; 
            
            // console.log("portfolio Amount "+portfolioAmount );
            console.log("comp fund "+compFund );
            console.log(FundData);
           
            document.getElementById("message1").innerHTML = "Comparing the selected fund, " + compFund + ", with rest of the Portfolio";

            for (row in FundData){
                // multiply the security fractional ammount with the fund amount
                var Amount = UserFunds[1][ UserFunds[0].indexOf(FundData[row][0])];
                var secAmount = (FundData[row][3]*Amount);
                FundData[row].push(secAmount );

                //sumarise by security wise
                if ( FundData[row][1] in securityWise ){     // { "security name 1" : [ amount , portfolio_percentage, compfund_shareholding], "security name w" : [ amount , portfolio_percentage, compfund_shareholding],...  }
                    // security already exists, add the amounts
                    securityWise[FundData[row][1]][0] += secAmount; // amount
                    securityWise[FundData[row][1]][1] += (secAmount/portfolioAmount); // as percentage
                    securityWise[FundData[row][1]][2] = checkCompFund(compFund,FundData[row]);

                } else{
                    //security doesnt exists, add the security and the amount
                    securityWise[FundData[row][1]] = [ secAmount , secAmount/portfolioAmount, checkCompFund(compFund,FundData[row]) ] ;
                }

                //sumarise by industry wise
                if ( FundData[row][2] in industryWise ){
                    // security already exists, add the amounts
                    industryWise[FundData[row][2]][0] += secAmount;
                    industryWise[FundData[row][2]][1] += secAmount/portfolioAmount;
                } else{
                    //security doesnt exists, add the security and the amount
                    industryWise[FundData[row][2]] = [ secAmount, secAmount/portfolioAmount];
                }

            }
            // console.log(FundData);
            console.log(securityWise);

            return [securityWise,industryWise];

        }

        function plot(securityWise,industryWise){

            // plot overview graphs
        
            var limit = 30;
            var data_sec = getSortedData(securityWise);  //  data_sec = [   [secuty 1, secury 2, ... ], [amt1, amt2,...],  [per1, per2,... ] ]
            var myChart_sec = new Chart("myChart_sec", {
                    type: "bar",
                    data: {labels: data_sec[0].slice(0, limit),
                        datasets: [{ data:data_sec[1].slice(0, limit)}]
                    },
                    options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: "Stockwise Distribution"
                                }
                            }
                        }

                    });

            var data_ind = getSortedData(industryWise);
            var myChart_ind = new Chart("myChart_ind", {
                    type: "bar",
                    data: {labels: data_ind[0].slice(0, limit),
                        datasets: [{ data:data_ind[1].slice(0, limit) }]
                    },
                    options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: "Industry wise Distribution"
                                }
                            }
                        }

                    });

    


        }

        function dotProduct(vectors){
            
            var dot_sum = 0;
            var a_sum = 0;
            var b_sum = 0;

            for (row in vectors){
                // console.log(vectors[row]);
                var a = Number(vectors[row][1] );
                var b = Number(vectors[row][2] );
                dot_sum += (a*b);
                a_sum += (a*a);
                b_sum += (b*b);
            }

            var value = (100*dot_sum/(Math.sqrt(a_sum)*Math.sqrt(b_sum))) ;
            console.log(value);
            return  Math.round(value );


        }

        function checkCompFund(fundName,fundDetailRow){
         
            if(fundName == fundDetailRow[0]){
                return (fundDetailRow[3]);
            }else{
                return 0;
            }
        }
        
        function getSortedData(dict){
   
            var items = Object.keys(dict).map(function(key) {
                  return [key, dict[key][0],dict[key][1]];
                });

            items.sort(function(first, second) {
                return second[1] - first[1];
            });

            items  = transpose(items);
            
            return items;

        }

        function getSortedOverlapData(a,b){
            if (a[2] === b[2]) {
                return 0;
            }
            else {
                return (a[2] > b[2]) ? -1 : 1;
            }
            
        }

        function transpose(arr){
            var arr_t = arr[0].map((_, colIndex) => arr.map(row => row[colIndex])); // transpose
            return arr_t
        }

        function get_Funds(){
            document.getElementById("message2").innerHTML= "Calculating...." ;
            var FundSelected = [];
        
            // get the funds selected in the form of an array
            for (var i=1 ; i < id ; i++){

                if (document.getElementById("FundInput"+i) != null){
                    var fund = document.getElementById("FundInput"+i).options[document.getElementById("FundInput"+i).selectedIndex].text;
                    var fundAmount = document.getElementById("Amount"+i).value;
                    var selected = document.getElementById("Fundselect"+i).checked;                
                    // console.log(fund);
                    FundSelected.push([fund,Number(fundAmount),selected]); 
                }
              

            }
            return FundSelected;
            // getdata(FundSelected);


        }

        function getCombinations(Funds){
            var array =  transpose(Funds)[0];
            var results = [];

                for (var i = 0; i < array.length - 1; i++) {
                    for (var j = i + 1; j < array.length; j++) {
                        results.push([array[i],array[j]]);
                    }
                }
        
            return results;

            }


        function AnalyzePortfolio(){
            var FundsSelected  = get_Funds();
            var FundData = [];
            
            getFundData(FundsSelected).then(function(data) {
            // Run this when your request was successful
            FundDatatDict = data;       
                for (fund in data){
                    for (sec in data[fund]){
                        FundData.push( [fund, data[fund][sec][0], data[fund][sec][1] , data[fund][sec][2]]);    
                    }
                }
            var [ securityWise, industryWise] = generatePorfolio(FundsSelected, FundData);

            console.log(securityWise);
            console.log(industryWise);
            plot(securityWise,industryWise);

            document.getElementById("FindAllOverlapsBtn").style.display = "block";

            }).catch(function(err) {
            // Run this when promise was rejected via reject()
            console.log(err);
            })

            

        }

        function FindSelectedOverlap(){
            var FundsSelected  = get_Funds();
            var FundData = [];
            
            getFundData(FundsSelected).then(function(data) {
            // Run this when your request was successful
            FundDatatDict = data;       
                for (fund in data){
                    for (sec in data[fund]){
                        FundData.push( [fund, data[fund][sec][0], data[fund][sec][1] , data[fund][sec][2]]);    
                    }
                }
            var [ securityWise, industryWise] = generatePorfolio(FundsSelected, FundData);

            // check the value of overlap
            document.getElementById("message2").innerHTML= "The overlap is " + dotProduct(securityWise) + " %" ;

            console.log(securityWise);
            console.log(industryWise);
        



            }).catch(function(err) {
            // Run this when promise was rejected via reject()
            console.log(err);
            })

        }

        function FindAllOverlaps(){
            var FundsSelected  = get_Funds();

            console.log(FundDatatDict);
   
            var combinations = getCombinations(FundsSelected)

            console.log(combinations);

            for (combi in combinations){

                var sec1 = FundDatatDict[combinations[combi][0]];
                var sec2 = FundDatatDict[combinations[combi][1]];

                var vectors = {};
                for ( sec in sec1){
                    vectors[sec1[sec][0]] = [sec1[sec][2], 0 ];
                }
                for (sec in sec2){
                    if (sec2[sec][0] in vectors){
                        vectors[sec2[sec][0]][1] = sec2[sec][2];
                    }else{
                        vectors[sec2[sec][0]] = [ 0, sec2[sec][2]];
                    }
                }

                var vector_arr =[];

                for (sec in vectors){
                    vector_arr.push( [ sec, vectors[sec][0],vectors[sec][1]]);    
                    }

                combinations[combi].push(dotProduct(vector_arr));
                combinations[combi].push( combinations[combi][0] + " & " +  combinations[combi][1]  );

                // console.log(vector_arr);

                // $("#message3").append(combinations[combi][0] + ", " + combinations[combi][1]+ "<br>");
                // $("#message3").append(dotProduct(vector_arr) +" %"+ "<br>");

            }
            // sort based on percentage

            combinations = combinations.sort(getSortedOverlapData);

            console.log(combinations);
            combinations = transpose(combinations);

            // plot
            const config = new Chart("myChart_overlap",{
                    type: 'horizontalBar',
                    data: {labels: combinations[3],
                        datasets: [{ data:combinations[2]}]
                    },
                    options: {
                        indexAxis: 'y',
                        // Elements options apply to all of the options unless overridden in a dataset
                        // In this case, we are setting the border of each horizontal bar to be 2px wide
                        elements: {
                        bar: {
                            borderWidth: 2,
                        }
                        },
                        responsive: true,
                        plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Chart.js Horizontal Bar Chart'
                        }
                        }
                    },
                    });


        }
        </script>


</head>
<body>
	
    <h1>Portfolio Analyser
    </h1>
    <h2>
        Mutual fund overlap analysis and fund distribution
    </h2>

    <h4>   Steps:</h4>
    <h6>
        <br>Add each fund in your portfolio along with the invested amount.
        <br>
        <h5>Options Available</h5>
        
        <br>1. To view distribution of your portfolio by stocks and by industry, click "Analyze Portfolio".
        <br>2. To check the Overlap of a certain fund with the portfolio, select the fund using the checkbox next to it and click "Find Overlap with Selected"
        <br>3. To check for the Overlap between all pair wise combinations of the funds in your portfolio, click on "Find all Overlaps"
        <br>
        <br>Note: 
        <br>You can select only one fund to compare with the portfolio. Portfolio includes the fund selected.
        <br>Option 3 is enabled only after "Analyze Portfolio"
        <br>If you dont find your fund, send an email to roshanm0903@gmail.com mentioning the fundname.
    </h6>

    <section class="w-100 p-4 d-flex justify-content-center pb-4">
   
    <div>

    
    <form style="width: 50rem;">
        <div>
        </div>

    <div id='Funds'>
    </div>
    
    <div class="row">
    <button type="button" id="AddFundsBtn" onclick="addRow()" class="btn btn-primary btn-block mb-4">Add Fund</button>
    </div>
    
    <br>
    <br>
    <button type="button" id="AnalyzePortfolioBtn" onclick="AnalyzePortfolio()" class="btn btn-primary btn-block mb-4">Analyze Portfolio</button>

    <button type="button" id="FindSelectedOverlapBtn" onclick="FindSelectedOverlap()" class="btn btn-primary btn-block mb-4">Find overlap with selected</button>

    <button type="button" id="FindAllOverlapsBtn" onclick="FindAllOverlaps()" class="btn btn-primary btn-block mb-4">Find all overlaps</button>
    
    </form>
    </div>
    

</section>

<p id="message1">
</p>
<br>
<h2 id="message2">

</h2>

<p id="message3">
</p>

<canvas id="myChart_sec" style="width:100%;max-width:700px"></canvas>
<canvas id="myChart_ind" style="width:100%;max-width:700px"></canvas>
<canvas id="myChart_overlap" style="width:100%;max-width:700px"></canvas>


</body>
</html>
