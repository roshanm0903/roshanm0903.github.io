<!DOCTYPE html>
<html lang=”en” manifest="/cache.appcache">
<head>
     <script async src="https://www.googletagmanager.com/gtag/js?id=G-VG8YQ8739T"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VG8YQ8739T');
    </script>
	
    <title>Portfolio Analyzer</title>
    <meta name="description" content="Free tool to analyze mutual fund portfolio and find overlaps to reduce risks of concentration.">

    <meta name="viewport" content="width=device-width" />

    
	<script type="text/javascript" 
            src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" /> 
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>


    <script src="calculations.js"></script>
    <script src="plot.js"></script>


	<script type="text/javascript">
        var FundDetails = [];
        var FundSelected = [];
        var FundData = [];
        var FundDatatDict = {};
        var id = 1;

        $(document).ready(function () {		
            document.getElementById("AddFundsBtn").style.display = "none";
            document.getElementById("AnalyzePortfolioBtn").style.display = "none";
            document.getElementById("FindSelectedOverlapBtn").style.display = "none";
            document.getElementById("FindAllOverlapsBtn").style.display = "none";
            document.getElementById("message2").innerHTML= '<div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">\
                                                                <span class="sr-only">Loading...</span>\
                                                            </div>';
        $("#FundInput").select2();

        // old url      url: "https://script.google.com/macros/s/AKfycbzEqBzXTk0EPb9Hln-sw72hkUnDZD0C4_c_9laHcpL9KglW5R3ZLUpgrtgZpwcoxncYXg/exec"
			$.ajax({ 
           method: "get", 
           url: "https://portfolioanalyzer.000webhostapp.com/getdata.php?Type=FundNames&FundNames=",
        //    data: {}
                error: function (err) {
                    document.getElementById("message2").innerHTML= "Erro Loading Data : " + JSON.stringify(err, null, 2);
            }


         }).done(function( data ) { 

           var result = data; 
		   	console.log(result.data[1].FundName);
            document.getElementById("message2").innerHTML= "Loaded" ;
			// console.log("Printing result");
            document.getElementById("AddFundsBtn").style.display = "block";

			for (fund in result.data){
				// console.log(result.data[fund].FundName);
				FundDetails.push([result.data[fund].FundName, result.data[fund].Link]);

			}
			// console.log(FundDetails);


		});
    });
        
        function RemoveFundRow(fundRowId){
            document.getElementById(fundRowId).remove();
        }

        function addRow(){

            var DivString = '<div >\
                                <div class="row" id="FundRow' + id +'">\
                                    <div class="col-1">\
                                            <input type="checkbox" class="check-input" id="Fundselect' + id +'">\
                                    </div>\
                                    <div class="col-8">\
                                        <select class="js-example-responsive" style="width: 100%" id="FundInput' + id +'">\
                                            <option value="" disabled selected>Select your fund</option>';
                                                for (fund in FundDetails){
                                                    DivString += '<option>' + FundDetails[fund][0] + '</option>';
                                                }
                                            
            DivString +=                '</select>\
                                    </div>\
                                    <div class="col-2">\
                                        <input type="number" style="width:100%" placeholder="Enter Amount" id="Amount' + id +'">\
                                    </div>\
                                    <div class="col-1">\
                                        <button type="button" class="close"  style="padding: 0px 0px 0px 0px"  onclick= RemoveFundRow("FundRow' +id+ '")>\
                                            <span aria-hidden="true">&times;</span>\
                                        </button>\
                                    </div>\
                                </div>\
                            </div><br>';            
        

            

            // DivString = DivString + "</div></div>";
            $('#Funds').append(DivString); 
            $('#FundInput'+id).select2({
                // width: 'resolve'
            }
            );
    
    
            //one one can be selected
            $('input.check-input').on('change', function() {
                     $('input.check-input').not(this).prop('checked', false);  
                    });
            
            //restrict to numbers
            // $('input.number').on('input', function() {
            //     this.value = this.value.replace(/[^0-9.]/g,'').replace(/(\..*)\./g, '$1');
            // });


            document.getElementById("AnalyzePortfolioBtn").style.display = "block";
            
            if (id>1){
            document.getElementById("FindSelectedOverlapBtn").style.display = "block";
                document.getElementById("FindAllOverlapsBtn").style.display = "block";
            }
            id = id + 1;

        }
  
        function getFundData(Funds) {

            var fundname_concat = getFundNames(Funds);

            console.log("Getting data from appsciprt");

            // old API url "https://script.google.com/macros/s/AKfycbyIy6shJ7Mh1Zxlo3ERwMatVcXIEmNvvbn7smzQ6l0ki4cSQg62hfJicZUaduV-MgFF/exec",
            return new Promise(function(resolve, reject) {
                $.ajax({
                method: "get",
                url:    "https://portfolioanalyzer.000webhostapp.com/getdata.php",
                data: { Type:"FundHoldings", FundNames : fundname_concat },
                success: function(data) {
                    resolve(data["data"]); // Resolve promise and go to then()
                },
                error: function(err) {
                    document.getElementById("message2").innerHTML= "Erro Loading Data : " + JSON.stringify(err, null, 2);
                    reject(err); // Reject the promise and go to catch()
                }
                });
            });
        }

        function get_Funds(){
            document.getElementById("message2").innerHTML= '<div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">\
                                                                <span class="sr-only">Loading...</span>\
                                                            </div>';
            var FundSelected = [];
        
            // get the funds selected in the form of an array
            for (var i=1 ; i < id ; i++){

                if (document.getElementById("FundInput"+i) != null){
                    var fund = document.getElementById("FundInput"+i).options[document.getElementById("FundInput"+i).selectedIndex].text;
                    var fundAmount = document.getElementById("Amount"+i).value;
                    var selected = document.getElementById("Fundselect"+i).checked;                
                    // console.log(fund);
                    FundSelected.push([fund,Number(fundAmount),selected]); 
                }
              

            }
            return FundSelected;
            // getdata(FundSelected);


        }

        function putData(PortfolioFunds,Amount,Skew){

            return new Promise(function(resolve, reject) {
                $.ajax({
                method: "post",
                url:    "https://portfolioanalyzer.000webhostapp.com/putdata.php",
                data: { skew:Skew, amount:Amount, portfolioFunds: getFundNames(PortfolioFunds) },
                success: function(data) {
                    resolve(); // Resolve promise and go to then()

                },
                error: function(err) {
                    // document.getElementById("message2").innerHTML= "Erro Loading Data : " + JSON.stringify(err, null, 2);
                    // reject(err); // Reject the promise and go to catch()
                }
                });
            });

        }

        function AnalyzePortfolio(){
            document.getElementById("plots").innerHTML =" "; // clear canvas
            var FundsSelected  = get_Funds();
            var FundData = [];
            var CompFund = 0;
            var PortfolioAmount = 0;
            
            getFundData(FundsSelected).then(function(data) {
            // Run this when your request was successful
            FundDatatDict = data;  
            console.log(" herefsdfads fds");     
                for (fund in data){
                    for (sec in data[fund]){
                    // FundData.push( [fund, data[fund][sec][0], data[fund][sec][1] , data[fund][sec][2]]);   
                        FundData.push( [fund, data[fund][sec].Security, data[fund][sec].Sector , data[fund][sec].Share]);    
                    }
                    console.log("Fund dfadgdas is" + fund);
                }
            // console.log("fund data  iss   ");
            // console.log(FundData);

            var [ securityWise, industryWise,CompFund, PortfolioAmount] = generatePorfolio(FundsSelected, FundData);

            // console.log(securityWise);
            // console.log(industryWise);
            plot(securityWise,industryWise);
            var skew = getskewness(securityWise, industryWise);

            console.log(skew);
            
                        putData(FundsSelected, PortfolioAmount,skew).then(function(data){

                        }).catch(function(err) {
                        // Run this when promise was rejected via reject()
                        console.log(err);
                        })
                        

            document.getElementById("message2").innerHTML= " " ;

            }).catch(function(err) {
            // Run this when promise was rejected via reject()
            console.log(err);
            })


            

        }

        function FindSelectedOverlap(){
            document.getElementById("plots").innerHTML =" ";

            var FundsSelected  = get_Funds();
            var FundData = [];
            // console.log("Here");
            // console.log(FundsSelected);
            getFundData(FundsSelected).then(function(data) {
            // Run this when your request was successful
            FundDatatDict = data;       
                for (fund in data){
                    for (sec in data[fund]){
                        // FundData.push( [fund, data[fund][sec][0], data[fund][sec][1] , data[fund][sec][2]]);   
                        FundData.push( [fund, data[fund][sec].Security, data[fund][sec].Sector , data[fund][sec].Share]); 
                    }
                }
            var [ securityWise, industryWise, compFund] = generatePorfolio(FundsSelected, FundData);

            // check the value of overlap
            document.getElementById("message1").innerHTML = "Comparing the selected fund, " + compFund + ", with the entire Portfolio";
            
            var [overlapVlaue , securityWise] = dotProduct(securityWise);
            document.getElementById("message2").innerHTML= "The overlap is " + overlapVlaue + " %" ;

            // console.log(securityWise);
            // console.log(industryWise);

            // display the top securities that are overlapping
             // securityWise = [security, sec_portoflio %, sec_selected %, sec_portfolio*sec_selected] sort by column3  
            plotSecuritesOverlap(securityWise);


            }).catch(function(err) {
            // Run this when promise was rejected via reject()
            console.log(err);
            })

        }

        function FindAllOverlaps(){
            document.getElementById("plots").innerHTML =" ";

            var FundData = [];
            var PairWiseOverlap = [];
            
            var FundsSelected  = get_Funds();
            var combinations = getCombinations(FundsSelected);
             
            getFundData(FundsSelected).then(function(data) {
            // Run this when your request was successful
            var FundDatatDict = data; 

            for (combi in combinations){

                    var sec1 = FundDatatDict[combinations[combi][0]];
                    var sec2 = FundDatatDict[combinations[combi][1]];
                    console.log("printing sec1");
                    console.log(sec1);

                    var vectors = {};
                    for ( sec in sec1){
                        vectors[sec1[sec].Security] = [sec1[sec].Share, 0 ];
                    }
                    for (sec in sec2){
                        if (sec2[sec].Security in vectors){
                            vectors[sec2[sec].Security][1] = sec2[sec].Share;
                        }else{
                            vectors[sec2[sec].Security] = [ 0, sec2[sec].Share];
                        }
                    }

                    console.log(" vectors are ");
                    console.log(vectors);

                    var vector_arr =[];

                    for (sec in vectors){
                        vector_arr.push( [ sec, vectors[sec][0],vectors[sec][1]]);    
                        }

                    PairWiseOverlap.push( [ combinations[combi][0] + " & " +  combinations[combi][1], dotProduct(vector_arr)[0] ] );
                    
                
                    }
                    // sort based on percentage
                    PairWiseOverlap = PairWiseOverlap.sort(getSortedOverlapData);

                    plotPairWiseOverlap(PairWiseOverlap);
                    
                    document.getElementById("message2").innerHTML= "Done" ;

            }).catch(function(err) {
            // Run this when promise was rejected via reject()
            console.log(err);
            })


        }
        </script>


</head>

<style>

</style>

<body>
	<!-- <div class="container"> -->
    <h1>Portfolio Analyser
    </h1>
    
    <div class="row">
        <div class="col-1">

        </div>
        <div class="col-4">
            <h4>
                Mutual fund distribution across stocks & industry and overlap analysis<br>
            </h4>
            <a href="https://www.moneycontrol.com/news/business/personal-finance/avoiding-portfolio-overlap-while-investing-in-mutual-funds-9070951.html">Importance of checking for overlaps<br><br></a> 
        
            <!-- <section class="w-100 p-4 d-flex justify-content-center pb-4"> -->
                <div>
                    <!-- <form style="width: 30rem;"></form> -->
        
                    <div id='Funds'></div>

                    
                    <div class="row">
                    <button type="button" id="AddFundsBtn" onclick="addRow()" class="btn btn-primary btn-block mb-4">Add Fund</button>
                    </div>
                    
                    <br>
                    <br>
                    <button type="button" id="AnalyzePortfolioBtn" onclick="AnalyzePortfolio()" class="btn btn-primary btn-block mb-4">Analyze Portfolio</button>
                    <button type="button" id="FindSelectedOverlapBtn" onclick="FindSelectedOverlap()" class="btn btn-primary btn-block mb-4">Find overlap with selected</button>
                    <button type="button" id="FindAllOverlapsBtn" onclick="FindAllOverlaps()" class="btn btn-primary btn-block mb-4">Find all overlaps</button>
                    
                    <!-- </form> -->
                </div>
            <!-- </section>   -->

            <h4>   Steps:</h4>
            <p>
                Add each fund in your portfolio along with the invested amount.
                <br>
                <h5>Options Available</h5>
                
                    1. To view distribution of your portfolio by stocks and by industry, click "Analyze Portfolio".
                <br>2. To check the Overlap of a certain fund with the portfolio, select the fund using the checkbox next to it and click "Find Overlap with Selected"
                <br>3. To check for the Overlap between all pair wise combinations of the funds in your portfolio, click on "Find all Overlaps"
                <br>
                <br>Note: 
                <br>1. No PPI data is collected. All calculations happen locally on your browser.
                <br>2. You can select only one fund to compare with the portfolio. Portfolio includes the fund selected.
                <br>3. If you dont find your fund, send an email to roshanm0903@gmail.com mentioning the fundname.
            </p>

        </div>
        <div class="col-6">
            <div class="container">
                <h4 id="message2">
                </h4>
                <p id="message1">
                </p>
                <div id="plots">
                    <canvas id="myChart_sec" style="width:100%;"></canvas>
                    <canvas id="myChart_ind" style="width:100%;"></canvas>
                    <canvas id="myChart_overlap" style="width:100%;max-width:700px"></canvas>
                </div>
            </div>


            <br>
            <p id="message3">
            </p>
                        
            <h5 id="message4">
            </h5>
            
        </div>
        <div class="col-1">

        </div>
    
    </div>

<!-- </div> -->





<h7>Data sourced from moneycontrol.com</h7>
</body>
</html>